- stage: Build
  displayName: Build and Package Next.js App
  jobs:
  - job: Build
    steps:
    - task: NodeTool@0
      displayName: 'Install Node.js'
      inputs:
        versionSpec: '20.x'

    - script: npm ci
      displayName: 'Install dependencies'

    - script: npm run build
      displayName: 'Build Next.js app'

    # Copy ONLY the runtime output
    - task: CopyFiles@2
      displayName: "Prepare build output"
      inputs:
        SourceFolder: '$(System.DefaultWorkingDirectory)'
        Contents: |
          .next/**
          public/**
          package.json
          package-lock.json
        TargetFolder: '$(Build.ArtifactStagingDirectory)/app'

    # Optional: copy node_modules if using "next start" without Oryx
    - script: npm ci --omit=dev
      displayName: "Install production node_modules"
      workingDirectory: '$(Build.ArtifactStagingDirectory)/app'

    # Zip final runtime app
    - task: ArchiveFiles@2
      displayName: 'Archive app into zip'
      inputs:
        rootFolderOrFile: '$(Build.ArtifactStagingDirectory)/app'
        includeRootFolder: false
        archiveType: 'zip'
        archiveFile: '$(Build.ArtifactStagingDirectory)/app.zip'
        replaceExistingArchive: true

    - publish: $(Build.ArtifactStagingDirectory)/app.zip
      artifact: drop


